<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#5b9279" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Cattle AI Monitor</title>
<!-- RemixIcon CDN -->
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<style>
  /* ---------- Mobile-first base styles with clean white theme ---------- */
  :root {
    /* Clean white theme with green accents */
    --bg-light: #ffffff;
    --bg-lighter: #f8f9fa;
    --card-bg: #ffffff;
    --accent: rgb(194, 122, 71);
    --accent-hover: rgb(154, 88, 40);
    --accent-light: rgb(194, 122, 71);
    --muted: #6c757d;
    --muted-darker: #495057;
    --text-primary: #212529;
    --text-secondary: #495057;
    --good: #28a745;
    --warn: #ffc107;
    --danger: #dc3545;
    --glass: rgba(0,0,0,0.04);
    --border: #e9ecef;
    --shadow: rgba(0, 0, 0, 0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  /* Clean white background */
  html, body {
    height: 100%;
    background: var(--bg-light);
    color: var(--text-primary);
    overflow-x: hidden;
  }
  
  /* Splash screen */
  #splash-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-light);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }
  
  .splash-logo {
    width: 80px;
    height: 80px;
    background-color: var(--accent);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    font-size: 2.5rem;
    color: white;
    box-shadow: 0 8px 24px var(--shadow);
  }
  
  .splash-text {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
  }
  
  .splash-subtext {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  /* Auth screens */
  #auth-screen {
    min-height: 100vh;
    padding: 40px 24px 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    max-width: 400px;
    margin: 0 auto;
  }
  
  .auth-header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  
  .auth-logo {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    font-size: 2rem;
    color: white;
  }
  
  .auth-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text-primary);
  }
  
  .auth-subtitle {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .auth-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 4px 16px var(--shadow);
    margin-bottom: 16px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .form-input {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 1rem;
    transition: all 0.2s ease;
  }
  
  .form-input:focus {
    outline: none;
    border-color: var(--accent);
    background: white;
    box-shadow: 0 0 0 3px rgba(91, 146, 121, 0.1);
  }
  
  .form-input.with-icon {
    padding-left: 44px;
  }
  
  .input-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted-darker);
    font-size: 1.1rem;
  }
  
  .input-wrapper {
    position: relative;
  }
  
  .auth-link {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .auth-link:hover {
    text-decoration: underline;
  }
  
  /* Main app container - hidden by default */
  .app {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .app-loaded {
    opacity: 1;
  }
  
  .app-header {
    padding: 16px 16px 0;
    background: var(--bg-light);
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 1px solid var(--border);
  }
  
  .app-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 16px;
  }
  
  h1 {
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--text-primary);
  }
  
  .header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .header-btn {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 1.2rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .header-btn:hover {
    background: var(--bg-lighter);
    color: var(--accent);
  }
  
  .header-btn.logout {
    color: var(--danger);
  }
  
  .header-btn.logout:hover {
    background: rgba(220, 53, 69, 0.1);
  }
  
  /* Main content area */
  .app-main {
    flex: 1;
    padding: 16px 16px 20px;
  }
  
  /* Clean card design with subtle shadows */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 2px 8px var(--shadow);
    margin-bottom: 16px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    box-shadow: 0 4px 12px var(--shadow);
  }
  
  /* Primary button with accent color */
  .big-btn {
    display: block;
    width: 100%;
    padding: 16px 20px;
    border-radius: 12px;
    background: var(--accent);
    border: 0;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  
  .big-btn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(91, 146, 121, 0.25);
  }
  
  .big-btn:active {
    transform: translateY(0);
  }
  
  /* Scan button at the top */
  .scan-top-btn {
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color: white;
    padding: 18px;
    margin-bottom: 20px;
    font-size: 1.05rem;
  }
  
  .scan-top-btn i {
    font-size: 1.3rem;
  }
  
  /* Enhanced stats cards */
  .stats {
    display: flex;
    gap: 10px;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  
  .stat {
    flex: 1;
    padding: 16px 12px;
    border-radius: 12px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    text-align: center;
    transition: all 0.2s ease;
  }
  
  .stat:hover {
    background: white;
    border-color: var(--accent-light);
  }
  
  /* Improved animal cards with hover effect */
  .animal-card {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 16px;
    border-radius: 12px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .animal-card:hover {
    background: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow);
    border-color: var(--accent-light);
  }
  
  /* Avatar design with icon background */
  .avatar {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.5rem;
    flex-shrink: 0;
    color: white;
  }
  
  .avatar i {
    font-size: 2rem;
  }
  
  .muted {
    color: var(--muted);
    font-size: 0.875rem;
  }
  
  .status-healthy {
    color: var(--good);
    font-weight: 600;
  }
  
  .status-warn {
    color: var(--warn);
    font-weight: 600;
  }
  
  .status-critical {
    color: var(--danger);
    font-weight: 600;
  }
  
  /* Enhanced alert rows */
  .alert-row {
    display: flex;
    gap: 10px;
    align-items: center;
    padding: 14px;
    border-radius: 10px;
    background: var(--bg-lighter);
    border: 1px solid var(--border);
    margin-bottom: 8px;
    transition: all 0.2s ease;
  }
  
  .alert-row:hover {
    background: white;
    border-color: var(--accent-light);
  }
  
  .small {
    font-size: 0.8rem;
  }
  
  /* Footer navigation */
  .app-footer {
    padding: 12px 0;
    display: flex;
    gap: 8px;
    justify-content: space-around;
    position: sticky;
    bottom: 0;
    background: var(--bg-light);
    border-top: 1px solid var(--border);
    backdrop-filter: blur(10px);
  }
  
  .nav-btn {
    background: transparent;
    border: 0;
    color: var(--muted-darker);
    font-weight: 600;
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  
  .nav-btn:hover {
    color: var(--accent);
    background: var(--bg-lighter);
  }
  
  .nav-btn.active {
    color: var(--accent);
    background: rgba(91, 146, 121, 0.1);
  }
  
  .nav-icon {
    font-size: 1.2rem;
  }
  
  .nav-label {
    font-size: 0.7rem;
  }
  
  /* Views */
  .view {
    display: none;
  }
  
  .view.active {
    display: block;
  }
  
  /* Modal design */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 30;
    padding: 16px;
  }
  
  .modal {
    width: 100%;
    max-width: 420px;
    border-radius: 16px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    animation: modalSlideIn 0.3s ease;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .center {
    text-align: center;
  }
  
  input[type=file] {
    display: none;
  }
  
  /* Better progress bar */
  .progress {
    height: 8px;
    background: var(--bg-lighter);
    border-radius: 999px;
    overflow: hidden;
    margin-top: 16px;
    margin-bottom: 8px;
  }
  
  .progress > i {
    display: block;
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    transition: width 0.1s linear;
    border-radius: 999px;
  }
  
  /* Enhanced section headers */
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  
  .section-title {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--text-primary);
  }
  
  /* Video styling in camera modal */
  #camera-video {
    border-radius: 12px;
    background: #000;
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    margin-bottom: 16px;
  }
  
  /* Camera preview image */
  #camera-preview {
    border-radius: 12px;
    width: 100%;
    max-height: 300px;
    object-fit: cover;
    margin-bottom: 16px;
    display: none;
  }
  
  /* Simple utility classes */
  .mb8 {
    margin-bottom: 8px;
  }
  
  .mt8 {
    margin-top: 10px;
  }
  
  .text-xs {
    font-size: 0.75rem;
  }
  
  /* Ghost button */
  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    padding: 10px 16px;
    border-radius: 10px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .btn-ghost:hover {
    background: var(--bg-lighter);
    border-color: var(--muted);
    color: var(--text-primary);
  }
  
  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
    position: relative;
  }
  
  .divider-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    padding: 0 12px;
    color: var(--muted);
    font-size: 0.8rem;
  }
  
  /* Profile page styles */
  .profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .profile-stats {
    display: flex;
    gap: 16px;
    justify-content: space-between;
    padding: 20px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    margin: 20px 0;
  }
  
  /* Profile screen specific styles */
  .profile-section {
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }
  
  .profile-section:last-child {
    border-bottom: none;
  }
  
  .profile-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
  }
  
  .profile-label {
    color: var(--muted);
    font-weight: 500;
  }
  
  .profile-value {
    font-weight: 600;
  }
  
  .profile-avatar-large {
    width: 80px;
    height: 80px;
    border-radius: 20px;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
    font-size: 2.5rem;
    color: white;
  }
  
  .danger-zone {
    background: rgba(220, 53, 69, 0.05);
    border: 1px solid rgba(220, 53, 69, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
  }
  
  .info-note {
    background: rgba(91, 146, 121, 0.1);
    border-radius: 10px;
    padding: 16px;
    margin: 16px 0;
    border-left: 4px solid var(--accent);
    font-size: 0.9rem;
  }
  
  /* Desktop tweaks */
  @media(min-width: 800px) {
    .app {
      max-width: 500px;
    }
    
    .app-header {
      padding: 20px 24px 0;
    }
    
    .app-main {
      padding: 20px 24px 20px;
    }
    
    h1 {
      font-size: 1.5rem;
    }
    
    .card {
      padding: 24px;
    }
  }
  
  /* Hide elements utility */
  .hidden {
    display: none !important;
  }
  
  /* Camera action buttons */
  .camera-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }
  
  .camera-actions .btn-ghost {
    flex: 1;
  }
  
  .camera-actions .big-btn {
    flex: 2;
    margin: 0;
  }
  
  /* Loading indicator */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top: 2px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Scan Results Modal Styles */
  .scan-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  
  .scan-results-title {
    font-weight: 700;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .scan-result-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .scan-result-item:last-child {
    border-bottom: none;
  }
  
  .scan-result-label {
    color: var(--muted);
    font-weight: 500;
  }
  
  .scan-result-value {
    font-weight: 600;
    text-align: right;
  }
  
  .scan-result-good {
    color: var(--good);
  }
  
  .scan-result-warning {
    color: var(--warn);
  }
  
  .scan-result-danger {
    color: var(--danger);
  }
  
  .scan-result-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .scan-result-actions .btn-ghost {
    flex: 1;
  }
  
  .scan-result-actions .big-btn {
    flex: 2;
    margin: 0;
  }
  
  /* Status indicator */
  .status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
  }
  
  .status-indicator.good {
    background: rgba(40, 167, 69, 0.1);
    color: var(--good);
  }
  
  .status-indicator.warning {
    background: rgba(255, 193, 7, 0.1);
    color: var(--warn);
  }
  
  .status-indicator.danger {
    background: rgba(220, 53, 69, 0.1);
    color: var(--danger);
  }
  
  /* Animal match section */
  .animal-match {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--bg-lighter);
    border-radius: 12px;
    margin: 16px 0;
    border: 1px solid var(--border);
  }
  
  .animal-match-info {
    flex: 1;
  }
  
  .animal-match-name {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 4px;
  }
  
  .match-confidence {
    font-size: 0.85rem;
    color: var(--muted);
  }
  
  /* Toast notification */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: var(--text-primary);
    color: white;
    padding: 12px 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s ease;
    font-weight: 500;
  }
  
  .toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
  
  .toast.success {
    background: var(--good);
  }
  
  .toast.error {
    background: var(--danger);
  }
  
  .toast.warning {
    background: var(--warn);
  }
  
  /* Camera mode selector */
  .camera-mode-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  
  .mode-btn {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--border);
    background: var(--bg-lighter);
    border-radius: 10px;
    cursor: pointer;
    text-align: center;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .mode-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  .mode-btn:hover:not(.active) {
    background: white;
    border-color: var(--accent);
  }
  
  /* Multi-image upload styles */
  .image-upload-container {
    margin: 16px 0;
  }
  
  .uploaded-images-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 16px 0;
  }
  
  .uploaded-image-item {
    position: relative;
    width: 100%;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--border);
  }
  
  .uploaded-image-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .remove-image-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--danger);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    cursor: pointer;
  }
  
  .image-count-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--accent);
    color: white;
    border-radius: 50%;
    font-size: 0.8rem;
    font-weight: 600;
    margin-left: 8px;
  }
  
  .upload-instructions {
    background: rgba(91, 146, 121, 0.1);
    border-radius: 10px;
    padding: 12px;
    margin: 12px 0;
    font-size: 0.85rem;
    border-left: 3px solid var(--accent);
  }
  
  .upload-instructions ul {
    margin: 8px 0 8px 16px;
  }
  
  .upload-instructions li {
    margin-bottom: 4px;
  }
  
  .capture-count {
    font-weight: 600;
    color: var(--accent);
    font-size: 1.1rem;
  }
  
  /* File upload area */
  .file-upload-area {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    margin: 16px 0;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .file-upload-area:hover {
    border-color: var(--accent);
    background: rgba(91, 146, 121, 0.05);
  }
  
  .file-upload-area i {
    font-size: 2rem;
    color: var(--accent);
    margin-bottom: 12px;
  }
  
  /* Video recorder styles */
  .video-recorder {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  
  .recording-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--danger);
    font-weight: 600;
    justify-content: center;
    margin-bottom: 16px;
  }
  
  .recording-dot {
    width: 12px;
    height: 12px;
    background-color: var(--danger);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
  }
  
  .video-controls {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }
  
  .video-controls .btn-ghost {
    flex: 1;
  }
  
  .video-controls .big-btn {
    flex: 2;
    margin: 0;
  }
  
  .video-upload-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    padding: 16px;
    background: var(--bg-lighter);
    border: 2px dashed var(--border);
    border-radius: 12px;
    color: var(--muted);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 16px;
  }
  
  .video-upload-btn:hover {
    border-color: var(--accent);
    background: rgba(91, 146, 121, 0.05);
    color: var(--accent);
  }
  
  .video-upload-btn i {
    font-size: 1.2rem;
  }
  
  /* Video playback */
  #video-playback {
    width: 100%;
    border-radius: 12px;
    margin-bottom: 16px;
    display: none;
    max-height: 250px;
    object-fit: contain;
    background: #000;
  }
  
  .video-submit-btn {
    width: 100%;
    margin-top: 16px;
  }
</style>
</head>
<body>
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Splash Screen -->
  <div id="splash-screen">
    <div class="splash-logo">
      <img src="/cow.png" width="40" alt="">
    </div>
    <div class="splash-text">M<span style="color: chocolate;">oo</span>mbe</div>
    <div class="splash-subtext">Intelligent Livestock Management</div>
  </div>

  <!-- Auth Screens -->
  <div id="auth-screen" class="hidden">
    <!-- Login View -->
    <div id="auth-login" class="auth-view">
      <div class="auth-header">
        <div class="auth-logo">
          <img src="/cow.png" width="40" alt="">
        </div>
        <div class="auth-title">Welcome Back</div>
        <div class="auth-subtitle">Sign in to monitor your cattle</div>
      </div>
      
      <div class="auth-card">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <div class="input-wrapper">
            <i class="ri-mail-line input-icon"></i>
            <input type="email" class="form-input with-icon" id="login-email" placeholder="farmer@example.com">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Password</label>
          <div class="input-wrapper">
            <i class="ri-lock-line input-icon"></i>
            <input type="password" class="form-input with-icon" id="login-password" placeholder="Enter your password">
          </div>
        </div>
        
        <button class="big-btn" id="btn-login">
          <i class="ri-login-box-line"></i> Sign In
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <button class="big-btn" id="btn-google-login" style="background: #4285F4;">
          <i class="ri-google-fill"></i> Continue with Google
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <div class="center">
          <button class="btn-ghost" id="btn-go-to-signup">
            <i class="ri-user-add-line"></i> Create New Account
          </button>
        </div>
      </div>
      
      <div class="center">
        <a href="#" class="auth-link" id="btn-forgot-password">
          <i class="ri-key-line"></i> Forgot Password?
        </a>
      </div>
    </div>
    
    <!-- Signup View -->
    <div id="auth-signup" class="auth-view hidden">
      <div class="auth-header">
        <div class="auth-logo">
          <img src="/cow.png" width="40" alt="">
        </div>
        <div class="auth-title">Create Account</div>
        <div class="auth-subtitle">Start monitoring your cattle</div>
      </div>
      
      <div class="auth-card">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <div class="input-wrapper">
            <i class="ri-user-line input-icon"></i>
            <input type="text" class="form-input with-icon" id="signup-name" placeholder="John Farmer">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <div class="input-wrapper">
            <i class="ri-mail-line input-icon"></i>
            <input type="email" class="form-input with-icon" id="signup-email" placeholder="farmer@example.com">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Password</label>
          <div class="input-wrapper">
            <i class="ri-lock-line input-icon"></i>
            <input type="password" class="form-input with-icon" id="signup-password" placeholder="Create a strong password (min. 6 chars)">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Confirm Password</label>
          <div class="input-wrapper">
            <i class="ri-lock-line input-icon"></i>
            <input type="password" class="form-input with-icon" id="signup-confirm" placeholder="Confirm your password">
          </div>
        </div>
        
        <button class="big-btn" id="btn-signup">
          <i class="ri-user-add-line"></i> Create Account
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <button class="big-btn" id="btn-google-signup" style="background: #4285F4;">
          <i class="ri-google-fill"></i> Continue with Google
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <div class="center">
          <button class="btn-ghost" id="btn-go-to-login">
            <i class="ri-login-box-line"></i> Already have an account?
          </button>
        </div>
      </div>
    </div>
    
    <!-- Forgot Password View -->
    <div id="auth-forgot" class="auth-view hidden">
      <div class="auth-header">
        <div class="auth-logo">
          <i class="ri-cow-line"></i>
        </div>
        <div class="auth-title">Reset Password</div>
        <div class="auth-subtitle">We'll send you a reset link</div>
      </div>
      
      <div class="auth-card">
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <div class="input-wrapper">
            <i class="ri-mail-line input-icon"></i>
            <input type="email" class="form-input with-icon" id="forgot-email" placeholder="Enter your email">
          </div>
        </div>
        
        <button class="big-btn" id="btn-send-reset">
          <i class="ri-mail-send-line"></i> Send Reset Link
        </button>
        
        <div class="divider">
          <div class="divider-text">or</div>
        </div>
        
        <div class="center">
          <button class="btn-ghost" id="btn-go-to-login-from-forgot">
            <i class="ri-arrow-left-line"></i> Back to Login
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App (initially hidden) -->
  <div class="app hidden" id="app">
    <!-- App Header -->
    <header class="app-header">
      <div class="app-header-content">
        <div>
          <h1>M<span style="color: chocolate;">oo</span>mbe</h1>
          
        </div>
        <div class="header-actions">
          <button class="header-btn" id="btn-notifications-header" title="Notifications">
            <i class="ri-notification-3-line"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="app-main">
      <!-- DASHBOARD VIEW -->
      <div id="view-dashboard" class="view active">
        <!-- Scan Button at Top -->
        <button class="big-btn scan-top-btn" id="btn-scan-top">
          <i class="ri-camera-3-line"></i> Scan Cattle
        </button>

        <section class="card">
          <div class="stats">
            <div class="stat">
              <div class="muted small">
                <i class="ri-cow-line"></i> Total Cattle
              </div>
              <div id="stat-animals" style="font-weight:700;font-size:1.4rem;margin-top:6px;color:var(--text-primary)">0</div>
            </div>
            <div class="stat">
              <div class="muted small">
                <i class="ri-heart-line"></i> Healthy
              </div>
              <div id="stat-healthy" style="font-weight:700;font-size:1.4rem;margin-top:6px;color:var(--good)">0</div>
            </div>
            <div class="stat">
              <div class="muted small">
                <i class="ri-alert-line"></i> Needs Attention
              </div>
              <div id="stat-sick" style="font-weight:700;font-size:1.4rem;margin-top:6px;color:var(--warn)">0</div>
            </div>
          </div>
          <div class="muted small center" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border);">
            <i class="ri-information-line"></i> Scan cattle to add them to your herd
          </div>
        </section>

        <section class="card">
          <div class="section-header">
            <div class="section-title">
              <i class="ri-alarm-warning-line"></i> Recent Alerts
            </div>
            <button class="btn-ghost" id="btn-open-alerts">
              <i class="ri-eye-line"></i> View all
            </button>
          </div>
          <div id="alerts-list">
            <div class="muted small" style="text-align:center;padding:20px">No alerts yet. Scan cattle to detect issues.</div>
          </div>
        </section>

        <section class="card">
          <div class="section-header">
            <div class="section-title">
              <i class="ri-cow-line"></i> Your Cattle
            </div>
            <div class="muted small">Tap to view details</div>
          </div>
          <div id="animals-list">
            <div class="muted small" style="text-align:center;padding:30px">
              <i class="ri-camera-line" style="font-size: 2rem; margin-bottom: 10px; display: block; color: var(--muted);"></i>
              No cattle in your herd yet.<br>
              <button class="btn-ghost" style="margin-top: 12px;" id="btn-first-scan">
                <i class="ri-camera-line"></i> Scan Your First Cattle
              </button>
            </div>
          </div>
        </section>
      </div>

      <!-- ANIMAL PROFILE VIEW -->
      <div id="view-animal-profile" class="view">
        <section class="card">
          <div class="profile-header">
            <div>
              <div id="profile-name" style="font-weight:700;font-size:1.3rem;margin-bottom:4px">--</div>
              <div class="muted small" id="profile-tag">--</div>
            </div>
            <div class="avatar" id="profile-avatar">
              <i class="ri-cow-line"></i>
            </div>
          </div>

          <div class="profile-stats">
            <div style="flex:1">
              <div class="muted small">
                <i class="ri-restaurant-line"></i> Last Scan
              </div>
              <div id="profile-lastfeed" style="font-weight:600;margin-top:4px">--</div>
            </div>
            <div style="flex:1">
              <div class="muted small">
                <i class="ri-heart-line"></i> Health
              </div>
              <div id="profile-health" style="font-weight:600;margin-top:4px" class="status-healthy">--</div>
            </div>
          </div>

          <div class="mt8">
            <button class="big-btn" id="profile-scan">
              <i class="ri-camera-line"></i> Scan This Cattle Again
            </button>
            <button class="big-btn" id="profile-history">
              <i class="ri-history-line"></i> View Health History
            </button>
          </div>
        </section>

        <section class="card">
          <div class="section-title" style="margin-bottom:12px">
            <i class="ri-alarm-warning-line"></i> Health Alerts
          </div>
          <div id="profile-alerts">
            <div class="muted small" style="text-align:center;padding:20px">No alerts for this cattle</div>
          </div>
        </section>

        <div style="margin-top:12px">
          <button class="btn-ghost" id="back-to-dashboard">
            <i class="ri-arrow-left-line"></i> Back to Dashboard
          </button>
        </div>
      </div>

      <!-- ALERTS VIEW -->
      <div id="view-alerts" class="view">
        <section class="card">
          <div class="section-header">
            <div class="section-title">
              <i class="ri-alarm-warning-line"></i> All Alerts
            </div>
            <div class="chip" id="alerts-count">0</div>
          </div>
          <div id="alerts-all">
            <div class="muted small" style="text-align:center;padding:30px">No alerts in the system</div>
          </div>
        </section>
        <div style="margin-top:12px">
          <button class="btn-ghost" id="alerts-back">
            <i class="ri-arrow-left-line"></i> Back to Dashboard
          </button>
        </div>
      </div>

      <!-- USER PROFILE VIEW -->
      <div id="view-user-profile" class="view">
        <section class="card">
          <div class="center">
            <div class="profile-avatar-large">
              <i class="ri-user-line"></i>
            </div>
            <h2 id="user-profile-name" style="margin-bottom: 4px;">John Farmer</h2>
            <div class="muted small" id="user-profile-email">farmer@example.com</div>
          </div>
          
          <div class="profile-section">
            <div class="section-title" style="margin-bottom: 16px;">
              <i class="ri-information-line"></i> Account Information
            </div>
            
            <div class="profile-item">
              <div class="profile-label">Account Type</div>
              <div class="profile-value">Premium Farmer</div>
            </div>
            
            <div class="profile-item">
              <div class="profile-label">Member Since</div>
              <div class="profile-value" id="user-member-since">2024</div>
            </div>
            
            <div class="profile-item">
              <div class="profile-label">Total Cattle</div>
              <div class="profile-value" id="user-total-cattle">0</div>
            </div>
            
            <div class="profile-item">
              <div class="profile-label">Active Alerts</div>
              <div class="profile-value" id="user-active-alerts">0</div>
            </div>
          </div>
          
          <div class="profile-section">
            <div class="section-title" style="margin-bottom: 16px;">
              <i class="ri-settings-3-line"></i> Settings
            </div>
            
            <div class="profile-item" style="cursor: pointer;" id="btn-notifications">
              <div>
                <div style="font-weight: 500;">Notifications</div>
                <div class="muted small">Manage alert preferences</div>
              </div>
              <i class="ri-arrow-right-s-line"></i>
            </div>
            
            <div class="profile-item" style="cursor: pointer;" id="btn-cattle-management">
              <div>
                <div style="font-weight: 500;">Cattle Management</div>
                <div class="muted small">Add/remove cattle, edit details</div>
              </div>
              <i class="ri-arrow-right-s-line"></i>
            </div>
            
            <div class="profile-item" style="cursor: pointer;" id="btn-privacy">
              <div>
                <div style="font-weight: 500;">Privacy & Data</div>
                <div class="muted small">Data usage and privacy settings</div>
              </div>
              <i class="ri-arrow-right-s-line"></i>
            </div>
          </div>
          
          <div class="danger-zone">
            <div class="section-title" style="color: var(--danger); margin-bottom: 16px;">
              <i class="ri-alert-line"></i> Account Actions
            </div>
            
            <div class="info-note">
              <strong><i class="ri-camera-video-line"></i> Video Capture Note:</strong><br>
              You can capture videos or upload existing videos of your cattle for more detailed health analysis. Videos can help detect movement patterns and behavioral issues.
            </div>
            
            <button class="big-btn" id="btn-change-password" style="background: var(--bg-lighter); color: var(--text-primary);">
              <i class="ri-key-line"></i> Change Password
            </button>
            
            <button class="big-btn logout" id="btn-logout-profile" style="background: var(--danger); margin-top: 12px;">
              <i class="ri-logout-box-r-line"></i> Log Out
            </button>
            
            <div class="muted small" style="text-align: center; margin-top: 16px;">
              Version 1.0.0 • Moombe Livestock AI
            </div>
          </div>
        </section>
        
        <div style="margin-top:12px">
          <button class="btn-ghost" id="user-profile-back">
            <i class="ri-arrow-left-line"></i> Back to Dashboard
          </button>
        </div>
      </div>
    </main>

    <!-- FOOTER NAV -->
    <footer class="app-footer">
      <button class="nav-btn active" data-view="dashboard" id="nav-dashboard">
        <i class="ri-home-4-line nav-icon"></i>
        <span class="nav-label">Home</span>
      </button>
      <button class="nav-btn" data-view="alerts" id="nav-alerts">
        <i class="ri-alarm-warning-line nav-icon"></i>
        <span class="nav-label">Alerts</span>
      </button>
      <button class="nav-btn" data-view="user-profile" id="nav-user-profile">
        <i class="ri-user-line nav-icon"></i>
        <span class="nav-label">Profile</span>
      </button>
    </footer>
  </div>

  <!-- CAMERA MODAL -->
  <div id="modal-camera" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <div class="section-header" style="margin-bottom:16px">
        <strong style="font-size:1.1rem">
          <i class="ri-camera-line"></i> Scan Cattle
        </strong>
        <button class="btn-ghost" id="modal-camera-close">
          <i class="ri-close-line"></i> Close
        </button>
      </div>
      
      <div class="camera-mode-selector">
        <button class="mode-btn active" id="mode-photo">
          <i class="ri-camera-line"></i> Photo
          <span class="image-count-badge" id="photo-count">0</span>
        </button>
        <button class="mode-btn" id="mode-video">
          <i class="ri-video-line"></i> Video
        </button>
      </div>
      
      <div class="center">
        <!-- Photo Mode Content -->
        <div id="photo-mode-content">
          <video id="photo-camera-preview" autoplay playsinline style="display:none; width:100%; border-radius: 12px; margin-bottom: 12px; background: #000;"></video>
          <div class="upload-instructions">
            <strong>For best analysis:</strong>
            <ul>
              <li>Upload <span class="capture-count">3 or more</span> photos of the same cattle</li>
              <li>Include different angles (side, front, back)</li>
              <li>Ensure good lighting</li>
              <li>Capture any visible wounds or issues</li>
            </ul>
          </div>
          
          <div class="uploaded-images-grid" id="uploaded-images-grid">
            <!-- Images will be added here -->
          </div>
          
          <div class="file-upload-area" id="file-upload-area">
            <i class="ri-folder-upload-line"></i>
            <div style="font-weight: 600; margin-bottom: 8px;">Upload Photos</div>
            <div class="muted small">Click to select or drag & drop images</div>
            <div class="muted text-xs" style="margin-top: 8px;">
              <i class="ri-information-line"></i> Minimum 3 photos required
            </div>
          </div>
          
          <input type="file" accept="image/*" id="camera-file-input" multiple>
          <div class="muted small mb8" id="photo-instruction">
            <span id="photos-count-text">0 photos uploaded</span> • Need at least 3 photos
          </div>

          <div class="camera-actions">
            <button class="btn-ghost" id="btn-upload-more">
              <i class="ri-folder-upload-line"></i> Upload More
            </button>
            <button class="btn-ghost" id="btn-take-photo" disabled>
              <i class="ri-camera-line"></i> Take Photo
            </button>
            <button class="big-btn" id="btn-analyze-photos" disabled style="opacity: 0.6;">
              <i class="ri-search-eye-line"></i> Analyze Photos
            </button>
          </div>
        </div>
        
        <!-- Video Mode Content -->
        <div id="video-mode-content" class="hidden">
          <video id="camera-video" autoplay playsinline></video>
          <video id="video-playback" controls style="display: none; width: 100%; border-radius: 12px; margin-bottom: 16px;"></video>
          
          <div class="recording-indicator hidden" id="recording-indicator">
            <div class="recording-dot"></div>
            <span>Recording video...</span>
          </div>
          
          <div class="muted small mb8" id="video-instruction">
            Record a video or upload existing video of cattle for movement analysis
          </div>
          
          <!-- Video Upload Button -->
          <div class="video-upload-btn" id="video-upload-btn">
            <i class="ri-folder-upload-line"></i>
            <span>Upload Video File</span>
          </div>
          <input type="file" accept="video/*" id="video-file-input" class="hidden">
          
          <div class="video-controls">
            <button class="btn-ghost" id="video-record-btn">
              <i class="ri-record-circle-line"></i> Start Recording
            </button>
            <button class="big-btn" id="video-stop-btn" style="display: none;">
              <i class="ri-stop-circle-line"></i> Stop Recording
            </button>
          </div>
          
          <button class="big-btn video-submit-btn" id="video-submit-btn" disabled style="opacity: 0.6;">
            <i class="ri-search-eye-line"></i> Submit Video for Scan
          </button>
        </div>
        
        <div class="progress"><i id="scan-progress"></i></div>
        
        <div class="muted small mt8" id="scan-status">
          Ready to scan
        </div>
      </div>
    </div>
  </div>

  <!-- SCAN RESULTS MODAL -->
  <div id="modal-results" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal">
      <div class="scan-results-header">
        <div class="scan-results-title">
          <i class="ri-search-eye-line"></i> Scan Results
        </div>
        <button class="btn-ghost" id="modal-results-close" style="padding: 8px 12px;">
          <i class="ri-close-line"></i> Close
        </button>
      </div>
      
      <div id="scan-results-content">
        <!-- Results will be populated here -->
      </div>
      
      <div class="scan-result-actions">
        <button class="btn-ghost" id="results-scan-other">
          <i class="ri-camera-line"></i> Scan Another
        </button>
        <button class="big-btn" id="results-view-profile">
          <i class="ri-cow-line"></i> View Cattle Profile
        </button>
      </div>
    </div>
  </div>

<script>
/* ===================
   Firebase Configuration
   =================== */
const firebaseConfig = {
  apiKey: "AIzaSyDr6z8B_p9sa_QBnKsthU8KfciRAfq5_ks",
  authDomain: "moombo-fafa8.firebaseapp.com",
  projectId: "moombo-fafa8",
  storageBucket: "moombo-fafa8.firebasestorage.app",
  messagingSenderId: "36732460150",
  appId: "1:36732460150:web:b64cb2e79d367386579357"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// Firebase Auth Providers
const googleProvider = new firebase.auth.GoogleAuthProvider();

/* ===================
   Toast Notification System
   =================== */
function showToast(message, type = 'info', duration = 3000) {
  const toast = el('#toast');
  toast.textContent = message;
  toast.className = 'toast';
  toast.classList.add(type);
  
  // Show toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);
  
  // Hide after duration
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.className = 'toast';
    }, 300);
  }, duration);
}

/* ===================
   EMPTY INITIAL STATE - No pre-existing data
   =================== */
const EMPTY_STATE = {
  animals: [], // Start with empty animals array
  alerts: [], // Start with empty alerts array
  user: null,
  scanCount: 0 // Track number of scans performed
}

/* ============
   Storage helpers with user-specific data
   ============ */
function loadState(userId){
  const key = `lam_mvp_v4_${userId || 'demo'}`; // Changed key to v4
  const raw = localStorage.getItem(key);
  if (!raw){
    localStorage.setItem(key, JSON.stringify(EMPTY_STATE));
    return JSON.parse(JSON.stringify(EMPTY_STATE));
  }
  try { 
    return JSON.parse(raw); 
  } catch(e){ 
    localStorage.setItem(key, JSON.stringify(EMPTY_STATE)); 
    return JSON.parse(JSON.stringify(EMPTY_STATE)); 
  }
}

function saveState(state, userId){
  const key = `lam_mvp_v4_${userId || 'demo'}`;
  localStorage.setItem(key, JSON.stringify(state));
}

let STATE = null;
let currentUser = null;

/* ====================
   Global variables for scan results
   ==================== */
let lastScanResult = null;
let lastScannedAnimal = null;

/* ====================
   Multi-photo upload variables
   ==================== */
let uploadedPhotos = [];
let currentCameraMode = 'photo'; // 'photo' or 'video'

/* ====================
   Video recording variables
   ==================== */
let mediaRecorder = null;
let recordedChunks = [];
let isRecording = false;
let cameraStream = null;
let currentVideoBlob = null;

/* ====================
   Utilities & helpers
   ==================== */
function el(q, ctx=document) { return ctx.querySelector(q); }
function els(q, ctx=document) { return Array.from(ctx.querySelectorAll(q)); }
function fmtTime(iso){ try{ const d=new Date(iso); return d.toLocaleString(); }catch(e){return iso;} }
function relativeTime(iso){
  const d=new Date(iso), now=new Date(); const diff=(now-d)/1000; if (diff<60) return Math.round(diff)+'s ago'; if (diff<3600) return Math.round(diff/60)+'m ago'; if (diff<86400) return Math.round(diff/3600)+'h ago'; return Math.round(diff/86400)+'d ago';
}

/* ====================
   Application Flow Control
   ==================== */
function initApp() {
  // Show splash screen first
  const splash = el('#splash-screen');
  splash.classList.remove('hidden');
  
  // After 1.5 seconds, initialize Firebase Auth and check user
  setTimeout(() => {
    splash.style.opacity = '0';
    
    setTimeout(() => {
      splash.classList.add('hidden');
      
      // Check Firebase auth state
      auth.onAuthStateChanged((user) => {
        if (user) {
          // User is signed in
          handleUserSignedIn(user);
        } else {
          // No user is signed in
          showAuthScreen('login');
        }
      });
    }, 500);
  }, 1500);
}

function handleUserSignedIn(user) {
  currentUser = {
    uid: user.uid,
    email: user.email,
    displayName: user.displayName || user.email.split('@')[0],
    photoURL: user.photoURL,
    loginTime: new Date().toISOString(),
    creationTime: user.metadata.creationTime || new Date().toISOString()
  };
  
  // Load user-specific data
  STATE = loadState(user.uid);
  STATE.user = currentUser;
  
  showMainApp();
}

function showAuthScreen(screen) {
  const authScreen = el('#auth-screen');
  const app = el('#app');
  
  authScreen.classList.remove('hidden');
  app.classList.add('hidden');
  
  // Show the requested auth screen
  els('.auth-view').forEach(view => view.classList.add('hidden'));
  if (screen === 'login') {
    el('#auth-login').classList.remove('hidden');
  } else if (screen === 'signup') {
    el('#auth-signup').classList.remove('hidden');
  } else if (screen === 'forgot') {
    el('#auth-forgot').classList.remove('hidden');
  }
}

function showMainApp() {
  const authScreen = el('#auth-screen');
  const app = el('#app');
  
  authScreen.classList.add('hidden');
  app.classList.remove('hidden');
  
  // Initialize the app UI
  setTimeout(() => {
    app.classList.add('app-loaded');
    boot();
  }, 100);
}

/* ====================
   Firebase Authentication Handlers
   ==================== */
// Email/Password Sign In
el('#btn-login').addEventListener('click', async function() {
  const email = el('#login-email').value.trim();
  const password = el('#login-password').value.trim();
  
  if (!email || !password) {
    showToast('Please enter both email and password', 'error');
    return;
  }
  
  try {
    showToast('Signing in...', 'info');
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    showToast('Welcome back!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Login error:', error);
    let message = 'Login failed. ';
    switch(error.code) {
      case 'auth/invalid-email':
        message += 'Invalid email address.';
        break;
      case 'auth/user-disabled':
        message += 'This account has been disabled.';
        break;
      case 'auth/user-not-found':
        message += 'No account found with this email.';
        break;
      case 'auth/wrong-password':
        message += 'Incorrect password.';
        break;
      default:
        message += error.message;
    }
    showToast(message, 'error');
  }
});

// Email/Password Sign Up
el('#btn-signup').addEventListener('click', async function() {
  const name = el('#signup-name').value.trim();
  const email = el('#signup-email').value.trim();
  const password = el('#signup-password').value.trim();
  const confirm = el('#signup-confirm').value.trim();
  
  if (!name || !email || !password || !confirm) {
    showToast('Please fill all fields', 'error');
    return;
  }
  
  if (password !== confirm) {
    showToast('Passwords do not match', 'error');
    return;
  }
  
  if (password.length < 6) {
    showToast('Password must be at least 6 characters', 'error');
    return;
  }
  
  try {
    showToast('Creating account...', 'info');
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    
    // Update display name
    await userCredential.user.updateProfile({
      displayName: name
    });
    
    showToast('Account created successfully!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Signup error:', error);
    let message = 'Signup failed. ';
    switch(error.code) {
      case 'auth/email-already-in-use':
        message += 'Email already in use.';
        break;
      case 'auth/invalid-email':
        message += 'Invalid email address.';
        break;
      case 'auth/operation-not-allowed':
        message += 'Email/password accounts are not enabled.';
        break;
      case 'auth/weak-password':
        message += 'Password is too weak.';
        break;
      default:
        message += error.message;
    }
    showToast(message, 'error');
  }
});

// Google Sign In/Sign Up
el('#btn-google-login').addEventListener('click', async function() {
  try {
    showToast('Connecting with Google...', 'info');
    const result = await auth.signInWithPopup(googleProvider);
    showToast('Signed in with Google!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Google auth error:', error);
    showToast('Google sign-in failed: ' + error.message, 'error');
  }
});

el('#btn-google-signup').addEventListener('click', async function() {
  try {
    showToast('Connecting with Google...', 'info');
    const result = await auth.signInWithPopup(googleProvider);
    showToast('Account created with Google!', 'success');
    // auth.onAuthStateChanged will handle the rest
  } catch (error) {
    console.error('Google auth error:', error);
    showToast('Google sign-in failed: ' + error.message, 'error');
  }
});

// Forgot Password
el('#btn-forgot-password').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('forgot');
});

el('#btn-send-reset').addEventListener('click', async function() {
  const email = el('#forgot-email').value.trim();
  
  if (!email) {
    showToast('Please enter your email', 'error');
    return;
  }
  
  try {
    showToast('Sending reset email...', 'info');
    await auth.sendPasswordResetEmail(email);
    showToast('Password reset email sent! Check your inbox.', 'success');
    
    // Go back to login after 2 seconds
    setTimeout(() => {
      showAuthScreen('login');
    }, 2000);
  } catch (error) {
    console.error('Password reset error:', error);
    let message = 'Failed to send reset email. ';
    switch(error.code) {
      case 'auth/invalid-email':
        message += 'Invalid email address.';
        break;
      case 'auth/user-not-found':
        message += 'No account found with this email.';
        break;
      default:
        message += error.message;
    }
    showToast(message, 'error');
  }
});

// Logout
function handleLogout() {
  if (confirm('Are you sure you want to logout?')) {
    try {
      auth.signOut();
      currentUser = null;
      STATE = null;
      showToast('Signed out successfully', 'success');
      showAuthScreen('login');
    } catch (error) {
      console.error('Logout error:', error);
      showToast('Logout failed: ' + error.message, 'error');
    }
  }
}

// Navigation between auth screens
el('#btn-go-to-signup').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('signup');
});

el('#btn-go-to-login').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('login');
});

el('#btn-go-to-login-from-forgot').addEventListener('click', function(e) {
  e.preventDefault();
  showAuthScreen('login');
});

/* ====================
   UI rendering
   ==================== */
function renderStats(){
  if (!STATE) return;
  const animals = STATE.animals.length;
  const healthy = STATE.animals.filter(a=>a.health_status==='Good').length;
  const sick = STATE.animals.filter(a=>a.health_status!=='Good').length;
  
  el('#stat-animals').textContent = animals;
  el('#stat-healthy').textContent = healthy;
  el('#stat-sick').textContent = sick;
}

/* Render animals list on dashboard */
function renderAnimalsList(){
  if (!STATE) return;
  const container = el('#animals-list'); 
  container.innerHTML='';
  
  if (STATE.animals.length === 0) {
    container.innerHTML = `
      <div class="muted small" style="text-align:center;padding:30px">
        <i class="ri-camera-line" style="font-size: 2rem; margin-bottom: 10px; display: block; color: var(--muted);"></i>
        No cattle in your herd yet.<br>
        <button class="btn-ghost" style="margin-top: 12px;" id="btn-first-scan">
          <i class="ri-camera-line"></i> Scan Your First Cattle
        </button>
      </div>
    `;
    
    // Add event listener for the first scan button
    const firstScanBtn = el('#btn-first-scan');
    if (firstScanBtn) {
      firstScanBtn.addEventListener('click', () => openCameraModal('scan', null));
    }
    return;
  }
  
  STATE.animals.forEach(a=>{
    const div=document.createElement('div'); div.className='animal-card';
    div.dataset.id=a.id;
    div.innerHTML = `
      <div class="avatar"><i class="${a.icon || 'ri-cow-line'}"></i></div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong style="font-size:1rem">${a.name}</strong><div class="muted small" style="margin-top:2px">${a.species} • ${a.tag}</div></div>
          <div style="text-align:right"><div class="${a.health_status==='Good'?'status-healthy':(a.health_status==='Warning'?'status-warn':'status-critical')}">${a.health_status}</div></div>
        </div>
      </div>
    `;
    div.addEventListener('click', ()=>openProfile(a.id));
    container.appendChild(div);
  });
}

/* Render alerts preview */
function renderAlertsPreview(){
  if (!STATE) return;
  const list = el('#alerts-list'); list.innerHTML='';
  const recent = STATE.alerts.slice().sort((x,y)=>new Date(y.timestamp)-new Date(x.timestamp)).slice(0,3);
  if (recent.length===0){ 
    list.innerHTML='<div class="muted small" style="text-align:center;padding:20px">No alerts yet. Scan cattle to detect issues.</div>'; 
    return; 
  }
  recent.forEach(a=>{
    const animal = STATE.animals.find(x=>x.id===a.animal_id);
    const div=document.createElement('div'); div.className='alert-row';
    div.innerHTML = `<div class="avatar" style="width:44px;height:44px;font-size:1.2rem;background:${a.severity==='High'?'var(--danger)':a.severity==='Medium'?'var(--warn)':'var(--good)'}"><i class="${animal?animal.icon:'ri-alarm-warning-line'}"></i></div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px;color:${a.severity==='High'?'var(--danger)':a.severity==='Medium'?'var(--warn)':'var(--good)'}">${animal?animal.name:'Unknown'}</div>
        <div class="muted small">${a.type} • ${relativeTime(a.timestamp)}</div>
      </div>
      <div><button class="btn-ghost" data-id="${a.alert_id}" style="padding:6px 12px;font-size:0.8rem;">
        <i class="ri-eye-line"></i> View
      </button></div>`;
    div.querySelector('button').addEventListener('click', ()=>openProfile(a.animal_id));
    list.appendChild(div);
  });
}

/* Render full alerts page */
function renderAllAlerts(){
  if (!STATE) return;
  el('#alerts-all').innerHTML='';
  const all = STATE.alerts.slice().sort((x,y)=>new Date(y.timestamp)-new Date(x.timestamp));
  el('#alerts-count').textContent = all.length;
  if (all.length===0){ el('#alerts-all').innerHTML='<div class="muted small" style="text-align:center;padding:30px">No alerts in the system</div>'; return; }
  all.forEach(a=>{
    const animal = STATE.animals.find(x=>x.id===a.animal_id);
    const div=document.createElement('div'); div.className='alert-row';
    div.innerHTML = `<div class="avatar" style="width:44px;height:44px;font-size:1.2rem;background:${a.severity==='High'?'var(--danger)':a.severity==='Medium'?'var(--warn)':'var(--good)'}"><i class="${animal?animal.icon:'ri-alarm-warning-line'}"></i></div>
      <div style="flex:1">
        <div style="font-weight:600;margin-bottom:2px">${animal?animal.name:'Unknown'}</div>
        <div class="muted small">${a.type} • ${fmtTime(a.timestamp)}</div>
      </div>
      <div><button class="btn-ghost" data-id="${a.alert_id}" style="padding:6px 12px;font-size:0.8rem;">
        <i class="ri-external-link-line"></i> Open
      </button></div>`;
    div.querySelector('button').addEventListener('click', ()=>openProfile(a.animal_id));
    el('#alerts-all').appendChild(div);
  });
}

/* Render user profile */
function renderUserProfile() {
  if (!STATE || !currentUser) return;
  
  el('#user-profile-name').textContent = currentUser.displayName;
  el('#user-profile-email').textContent = currentUser.email;
  
  // Calculate member since
  const memberSince = new Date(currentUser.creationTime);
  el('#user-member-since').textContent = memberSince.getFullYear();
  
  // Update stats
  const animals = STATE.animals.length;
  const activeAlerts = STATE.alerts.length;
  
  el('#user-total-cattle').textContent = animals;
  el('#user-active-alerts').textContent = activeAlerts;
}

/* Animal Profile render */
function openProfile(animalId){
  if (!STATE) return;
  const animal = STATE.animals.find(a=>a.id===animalId);
  if (!animal) return showToast('Animal not found', 'error');
  // populate
  el('#profile-name').textContent = animal.name;
  el('#profile-tag').textContent = animal.tag;
  el('#profile-avatar').innerHTML = `<i class="${animal.icon || 'ri-cow-line'}"></i>`;
  el('#profile-lastfeed').textContent = relativeTime(animal.last_feed);
  el('#profile-health').textContent = animal.health_status;
  el('#profile-health').className = animal.health_status==='Good' ? 'status-healthy' : (animal.health_status==='Warning' ? 'status-warn' : 'status-critical');
  // alerts for the animal
  const pa = el('#profile-alerts'); pa.innerHTML='';
  const alerts = STATE.alerts.filter(x=>x.animal_id===animalId).sort((x,y)=>new Date(y.timestamp)-new Date(x.timestamp));
  if (alerts.length===0) pa.innerHTML='<div class="muted small" style="text-align:center;padding:20px">No alerts for this cattle</div>';
  alerts.forEach(al=>{
    const d=document.createElement('div'); d.className='alert-row';
    d.innerHTML = `<div class="avatar" style="width:44px;height:44px;font-size:1.2rem;background:${al.severity==='High'?'var(--danger)':al.severity==='Medium'?'var(--warn)':'var(--good)'}"><i class="${animal.icon || 'ri-cow-line'}"></i></div>
      <div style="flex:1"><div style="font-weight:600;margin-bottom:2px">${al.type}</div><div class="muted small">${fmtTime(al.timestamp)}</div></div>
      <div><span class="${al.severity==='High'?'status-critical':(al.severity==='Medium'?'status-warn':'status-healthy')}">${al.severity}</span></div>`;
    pa.appendChild(d);
  });

  // switch views
  showView('animal-profile');
  // attach profile-specific actions
  el('#profile-scan').onclick = ()=>openCameraModal('scan', animal.id);
  el('#profile-history').onclick = ()=>openHealthHistory(animal.id);
}

/* Open health history modal */
function openHealthHistory(animalId) {
  const animal = STATE.animals.find(a=>a.id===animalId);
  if (!animal) return showToast('Animal not found', 'error');
  
  // Create health history modal
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal">
      <div class="section-header" style="margin-bottom:16px">
        <strong style="font-size:1.1rem">
          <i class="ri-history-line"></i> Health History - ${animal.name}
        </strong>
        <button class="btn-ghost close-history-modal">
          <i class="ri-close-line"></i> Close
        </button>
      </div>
      
      <div class="muted small mb8">
        <i class="ri-information-line"></i> Health tracking over time for ${animal.name}
      </div>
      
      <div id="health-history-content">
        <div class="muted small" style="text-align:center;padding:30px">
          <i class="ri-history-line" style="font-size: 2rem; margin-bottom: 10px; display: block; color: var(--muted);"></i>
          No health history recorded yet.<br>
          Scan this cattle to build health history.
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <button class="big-btn" id="scan-from-history">
          <i class="ri-camera-line"></i> Scan This Cattle Now
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Add event listeners
  modal.querySelector('.close-history-modal').onclick = () => {
    modal.remove();
  };
  
  modal.querySelector('#scan-from-history').onclick = () => {
    modal.remove();
    setTimeout(() => {
      openCameraModal('scan', animal.id);
    }, 300);
  };
}

/* Navigation: show specific view */
function showView(view){
  // hide all views
  els('.view').forEach(v=>v.classList.remove('active'));
  // show requested view
  el(`#view-${view}`).classList.add('active');
  
  // update footer nav
  els('.nav-btn').forEach(b=>b.classList.remove('active'));
  el(`#nav-${view}`).classList.add('active');
  
  // If showing user profile, render it
  if (view === 'user-profile') {
    renderUserProfile();
  }
}

/* Boot & render everything */
function boot(){
  if (!STATE || !currentUser) {
    showAuthScreen('login');
    return;
  }
  
  renderStats();
  renderAnimalsList();
  renderAlertsPreview();
  renderAllAlerts();
  renderUserProfile();
  showView('dashboard');
}

/* ==========================
   Multi-photo upload functionality - FIXED
   ========================== */
function updatePhotoUploadUI() {
  const count = uploadedPhotos.length;
  const photoCountBadge = el('#photo-count');
  const photosCountText = el('#photos-count-text');
  const analyzeBtn = el('#btn-analyze-photos');
  const uploadedImagesGrid = el('#uploaded-images-grid');
  
  // Update count badge
  photoCountBadge.textContent = count;
  
  // Update text
  photosCountText.textContent = `${count} photo${count !== 1 ? 's' : ''} uploaded`;
  
  // Enable/disable analyze button - FIXED: Should enable when count >= 3
  if (count >= 3) {
    analyzeBtn.disabled = false;
    analyzeBtn.style.opacity = '1';
    analyzeBtn.style.cursor = 'pointer';
    photosCountText.innerHTML = `<span style="color: var(--good);">${count} photos uploaded ✓ Ready to analyze</span>`;
  } else {
    analyzeBtn.disabled = true;
    analyzeBtn.style.opacity = '0.6';
    analyzeBtn.style.cursor = 'not-allowed';
    photosCountText.innerHTML = `${count} photos uploaded • Need ${3 - count} more`;
  }
  
  // Update image grid
  uploadedImagesGrid.innerHTML = '';
  
  uploadedPhotos.forEach((photo, index) => {
    const imgItem = document.createElement('div');
    imgItem.className = 'uploaded-image-item';
    
    const img = document.createElement('img');
    img.src = photo.preview;
    img.alt = `Uploaded photo ${index + 1}`;
    
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-image-btn';
    removeBtn.innerHTML = '<i class="ri-close-line"></i>';
    removeBtn.title = 'Remove this photo';
    removeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      removePhoto(index);
    });
    
    imgItem.appendChild(img);
    imgItem.appendChild(removeBtn);
    uploadedImagesGrid.appendChild(imgItem);
  });
  
  // Show/hide grid
  if (count > 0) {
    uploadedImagesGrid.classList.remove('hidden');
  } else {
    uploadedImagesGrid.classList.add('hidden');
  }
}

function addPhoto(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      uploadedPhotos.push({
        file: file,
        preview: e.target.result,
        name: file.name,
        size: file.size,
        type: file.type
      });
      
      updatePhotoUploadUI();
      resolve();
    };
    
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function removePhoto(index) {
  uploadedPhotos.splice(index, 1);
  updatePhotoUploadUI();
}

function clearPhotos() {
  uploadedPhotos = [];
  updatePhotoUploadUI();
}

/* ==========================
   Video recording functionality
   ========================== */
function updateVideoUI() {
  const hasVideo = currentVideoBlob !== null;
  const submitBtn = el('#video-submit-btn');
  
  if (hasVideo) {
    submitBtn.disabled = false;
    submitBtn.style.opacity = '1';
    submitBtn.style.cursor = 'pointer';
    el('#video-instruction').innerHTML = '<span style="color: var(--good);">Video ready for analysis ✓</span>';
  } else {
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.style.cursor = 'not-allowed';
    el('#video-instruction').textContent = 'Record a video or upload existing video of cattle for movement analysis';
  }
}

async function startVideoRecording() {
  if (!cameraStream) {
    showToast('Camera not available', 'error');
    return;
  }
  
  if (!isRecording) {
    try {
      mediaRecorder = new MediaRecorder(cameraStream, {
        mimeType: 'video/webm;codecs=vp9,opus'
      });
      
      recordedChunks = [];
      
      mediaRecorder.ondataavailable = function(event) {
        if (event.data.size > 0) {
          recordedChunks.push(event.data);
        }
      };
      
      mediaRecorder.onstop = function() {
        currentVideoBlob = new Blob(recordedChunks, { type: 'video/webm' });
        const videoPlayback = el('#video-playback');
        videoPlayback.src = URL.createObjectURL(currentVideoBlob);
        videoPlayback.style.display = 'block';
        el('#camera-video').style.display = 'none';
        
        isRecording = false;
        el('#recording-indicator').classList.add('hidden');
        el('#video-record-btn').style.display = 'inline-flex';
        el('#video-stop-btn').style.display = 'none';
        
        updateVideoUI();
        showToast('Video recorded successfully', 'success');
      };
      
      mediaRecorder.start(1000);
      isRecording = true;
      el('#recording-indicator').classList.remove('hidden');
      el('#video-record-btn').style.display = 'none';
      el('#video-stop-btn').style.display = 'inline-flex';
      showToast('Recording started', 'info');
      
      // Auto-stop after 60 seconds
      setTimeout(() => {
        if (isRecording && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          showToast('Recording stopped automatically after 60 seconds', 'info');
        }
      }, 60000);
      
    } catch (error) {
      console.error('Error recording video:', error);
      showToast('Video recording failed: ' + error.message, 'error');
    }
  }
}

function stopVideoRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    showToast('Recording stopped', 'info');
  }
}

/* ==========================
   Mock AI analysis for multiple photos - REALISTIC SCANNING
   ========================== */
function mockMultiPhotoAIAnalyze(photos) {
  // Track scan count for realistic progression
  STATE.scanCount = (STATE.scanCount || 0) + 1;
  
  const photoCount = photos.length;
  
  // Cattle names for realistic identification
  const cattleNames = ["Bessie", "Daisy", "Molly", "Clara", "Rosie", "Bella", "Maggie", "Buttercup", "Coco", "Luna"];
  const breeds = ["Holstein", "Jersey", "Angus", "Hereford", "Brahman", "Simmental", "Charolais", "Limousin", "Texas Longhorn"];
  
  // Based on scan count, determine what we find
  let isNewAnimal = false;
  let matchedAnimal = null;
  
  // For first scan: always find a new animal
  if (STATE.scanCount === 1) {
    isNewAnimal = true;
  } 
  // For second scan: 70% chance to find existing, 30% new
  else if (STATE.scanCount === 2) {
    isNewAnimal = Math.random() < 0.3;
    if (!isNewAnimal && STATE.animals.length > 0) {
      matchedAnimal = STATE.animals[0]; // Match first animal
    }
  }
  // For third scan: 60% chance to find existing, 40% new
  else if (STATE.scanCount === 3) {
    isNewAnimal = Math.random() < 0.4;
    if (!isNewAnimal && STATE.animals.length > 0) {
      // Pick random existing animal
      matchedAnimal = STATE.animals[Math.floor(Math.random() * STATE.animals.length)];
    }
  }
  // For subsequent scans: 80% chance to find existing
  else {
    isNewAnimal = Math.random() < 0.2;
    if (!isNewAnimal && STATE.animals.length > 0) {
      matchedAnimal = STATE.animals[Math.floor(Math.random() * STATE.animals.length)];
    }
  }
  
  // Generate realistic health data based on scan count
  let woundDetected = false;
  let overallHealth = "Good";

  // First scan: usually healthy
  if (STATE.scanCount === 1) {
    woundDetected = Math.random() < 0.1; // 10% chance
  }
  // Second scan: might have issues
  else if (STATE.scanCount === 2) {
    woundDetected = Math.random() < 0.3; // 30% chance
  }
  // Third scan: higher chance of issues
  else if (STATE.scanCount === 3) {
    woundDetected = Math.random() < 0.5; // 50% chance
  }
  // Subsequent scans: varied
  else {
    woundDetected = Math.random() < 0.25;
  }

  // Determine overall health (based on wound detection only)
  if (woundDetected) {
    overallHealth = Math.random() < 0.7 ? "Critical" : "Warning";
  }
  
  // Generate results
  const breed = breeds[Math.floor(Math.random() * breeds.length)];
  const confidence = 0.7 + (photoCount * 0.05) + (matchedAnimal ? 0.1 : 0); // Higher confidence for matches
  
  return {
    is_new_animal: isNewAnimal,
    matched_animal: matchedAnimal,
    wound_detected: woundDetected,
    wound_location: woundDetected ? ["hind leg", "front leg", "back", "side", "neck"][Math.floor(Math.random() * 5)] : null,
    confidence: Math.min(confidence, 0.95).toFixed(2),
    breed_detected: breed,
    overall_health: overallHealth,
    movement_score: woundDetected ? "Restricted" : "Active",
    photos_analyzed: photoCount,
    analysis_notes: `Analyzed ${photoCount} photos. ${isNewAnimal ? "New cattle detected." : "Matched existing cattle."}`,
    suggested_name: cattleNames[Math.floor(Math.random() * cattleNames.length)],
    tag_number: `QR-${String(STATE.animals.length + 1).padStart(3, '0')}`
  };
}

/* Mock video analysis */
function mockVideoAIAnalyze(videoBlob) {
  STATE.scanCount = (STATE.scanCount || 0) + 1;
  
  // Similar logic to photo analysis
  const cattleNames = ["Bessie", "Daisy", "Molly", "Clara", "Rosie"];
  const breeds = ["Holstein", "Jersey", "Angus", "Hereford"];
  
  let isNewAnimal = STATE.animals.length === 0 || Math.random() < 0.3;
  let matchedAnimal = null;
  
  if (!isNewAnimal && STATE.animals.length > 0) {
    matchedAnimal = STATE.animals[Math.floor(Math.random() * STATE.animals.length)];
  }
  
  // Health determination
  const woundDetected = Math.random() < 0.25;
  let overallHealth = "Good";

  if (woundDetected) {
    overallHealth = Math.random() < 0.7 ? "Critical" : "Warning";
  }
  
  // Video-specific analysis
  const movementScore = woundDetected ? "Restricted" : 
                       (Math.random() < 0.3 ? "Slightly impaired" : "Normal");
  
  const behaviorAnalysis = woundDetected ? "Favoring one leg" : 
                          (Math.random() < 0.25 ? "Possible stiffness detected" : "Normal gait pattern");
  
  return {
    is_new_animal: isNewAnimal,
    matched_animal: matchedAnimal,
    wound_detected: woundDetected,
    wound_location: woundDetected ? "hind leg" : null,
    confidence: (0.75 + Math.random() * 0.2).toFixed(2),
    breed_detected: breeds[Math.floor(Math.random() * breeds.length)],
    overall_health: overallHealth,
    movement_score: movementScore,
    behavior_analysis: behaviorAnalysis,
    video_duration: `${Math.floor(Math.random() * 30) + 10} seconds`,
    motion_patterns: movementScore === "Normal" ? "Smooth movement" : "Irregular gait detected",
    analysis_method: "Video motion analysis",
    suggested_name: cattleNames[Math.floor(Math.random() * cattleNames.length)],
    tag_number: `QR-${String(STATE.animals.length + 1).padStart(3, '0')}`
  };
}

/* ==========================
   Camera modal with multi-photo upload and video recording
   ========================== */
let scanInProgress = false;
let currentCameraTargetId = null; // animal id when triggered from profile

async function openCameraModal(mode='scan', targetId=null){
  currentCameraTargetId = targetId;
  currentCameraMode = 'photo'; // Start with photo mode
  
  // Reset photo uploads
  clearPhotos();
  currentVideoBlob = null;
  
  el('#modal-camera').classList.remove('hidden');
  el('#modal-camera').ariaHidden = 'false';
  el('#scan-status').textContent = 'Ready to upload photos';
  el('#scan-progress').style.width = '0%';
  scanInProgress = false;
  
  // Reset camera mode UI
  el('#mode-photo').classList.add('active');
  el('#mode-video').classList.remove('active');
  el('#photo-mode-content').classList.remove('hidden');
  el('#video-mode-content').classList.add('hidden');
  
  // Reset video UI
  el('#camera-video').style.display = 'block';
  el('#video-playback').style.display = 'none';
  el('#recording-indicator').classList.add('hidden');
  el('#video-record-btn').style.display = 'inline-flex';
  el('#video-stop-btn').style.display = 'none';
  
  // Update UI
  updatePhotoUploadUI();
  updateVideoUI();
  
  // Try to start camera for photo capture (mobile friendly)
  const photoPreview = el('#photo-camera-preview');
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });
    photoPreview.srcObject = cameraStream;
    photoPreview.style.display = 'block';
    await photoPreview.play();
    el('#btn-take-photo').disabled = false;
    el('#photo-instruction').innerHTML = '<span style="color: var(--muted);">Use camera or upload photos. Minimum 3 photos required</span>';
  } catch(e) {
    // Camera not available - fall back to file upload only
    photoPreview.srcObject = null;
    photoPreview.style.display = 'none';
    el('#btn-take-photo').disabled = true;
    el('#photo-instruction').innerHTML = 'Camera not available — please upload photos from your device';
  }
}

/* Close camera modal */
function closeCameraModal(){
  el('#modal-camera').classList.add('hidden');
  el('#modal-camera').ariaHidden = 'true';
  
  // Stop recording if active
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
  }
  
  // stop stream
  if (cameraStream) {
    cameraStream.getTracks().forEach(t=>t.stop());
    cameraStream = null;
  }
  
  scanInProgress = false;
  isRecording = false;
  recordedChunks = [];
  clearPhotos();
  currentVideoBlob = null;
}

/* Switch camera mode */
el('#mode-photo').addEventListener('click', async function() {
  if (currentCameraMode === 'photo') return;
  
  currentCameraMode = 'photo';
  el('#mode-photo').classList.add('active');
  el('#mode-video').classList.remove('active');
  el('#photo-mode-content').classList.remove('hidden');
  el('#video-mode-content').classList.add('hidden');
  
  // Stop recording if active
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
    el('#recording-indicator').classList.add('hidden');
  }
  
  // Try to start camera for photo mode
  const photoPreview = el('#photo-camera-preview');
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    photoPreview.srcObject = cameraStream;
    photoPreview.style.display = 'block';
    await photoPreview.play();
    el('#btn-take-photo').disabled = false;
    el('#photo-instruction').innerHTML = '<span style="color: var(--muted);">Use camera or upload photos. Minimum 3 photos required</span>';
  } catch(e) {
    photoPreview.srcObject = null;
    photoPreview.style.display = 'none';
    el('#btn-take-photo').disabled = true;
    el('#photo-instruction').innerHTML = 'Camera not available — please upload photos from your device';
  }

  // Clear photos when switching to photo mode
  clearPhotos();
});

el('#mode-video').addEventListener('click', async function() {
  if (currentCameraMode === 'video') return;
  
  currentCameraMode = 'video';
  el('#mode-photo').classList.remove('active');
  el('#mode-video').classList.add('active');
  el('#photo-mode-content').classList.add('hidden');
  el('#video-mode-content').classList.remove('hidden');
  
  // Clear photos when switching to video mode
  clearPhotos();
  
  // Start camera for video mode
  const video = el('#camera-video');
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment',
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }, 
      audio: false
    });
    video.srcObject = cameraStream;
    video.play();
    el('#video-instruction').textContent = 'Record a video or upload existing video of cattle for movement analysis';
  } catch(e) {
    video.srcObject = null;
    console.warn('Camera not available, use file upload fallback', e);
    el('#video-instruction').textContent = 'Camera not available. Please upload a video instead.';
    el('#video-record-btn').disabled = true;
  }
});

/* File upload handlers */
el('#file-upload-area').addEventListener('click', () => el('#camera-file-input').click());
el('#btn-upload-more').addEventListener('click', () => el('#camera-file-input').click());

/* Take photo from camera preview */
el('#btn-take-photo').addEventListener('click', async function() {
  const video = el('#photo-camera-preview');
  if (!video || !video.srcObject) {
    showToast('Camera not available', 'error');
    return;
  }

  try {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(async (blob) => {
      if (!blob) return showToast('Failed to capture photo', 'error');
      const file = new File([blob], `photo-${Date.now()}.jpg`, { type: 'image/jpeg' });
      await addPhoto(file);
      showToast('Photo captured', 'success');
    }, 'image/jpeg', 0.9);
  } catch (err) {
    console.error('Take photo error', err);
    showToast('Failed to capture photo', 'error');
  }
});

el('#camera-file-input').addEventListener('change', async function(ev) {
  const files = Array.from(ev.target.files);
  
  if (files.length === 0) return;
  
  // Filter only image files
  const imageFiles = files.filter(file => file.type.match('image.*'));
  
  if (imageFiles.length === 0) {
    showToast('Please select image files only', 'error');
    return;
  }
  
  // Check if adding these would exceed reasonable limit
  if (uploadedPhotos.length + imageFiles.length > 10) {
    showToast('Maximum 10 photos allowed', 'warning');
    return;
  }
  
  // Add each photo - FIXED: Now using await for each photo
  for (const file of imageFiles) {
    await addPhoto(file); // Wait for each photo to be added
  }
  
  // Reset file input
  ev.target.value = '';
  
  showToast(`Added ${imageFiles.length} photo${imageFiles.length !== 1 ? 's' : ''}`, 'success');
});

// Drag and drop support
el('#file-upload-area').addEventListener('dragover', (e) => {
  e.preventDefault();
  e.stopPropagation();
  el('#file-upload-area').style.borderColor = 'var(--accent)';
  el('#file-upload-area').style.background = 'rgba(91, 146, 121, 0.1)';
});

el('#file-upload-area').addEventListener('dragleave', (e) => {
  e.preventDefault();
  e.stopPropagation();
  el('#file-upload-area').style.borderColor = '';
  el('#file-upload-area').style.background = '';
});

el('#file-upload-area').addEventListener('drop', async (e) => {
  e.preventDefault();
  e.stopPropagation();
  el('#file-upload-area').style.borderColor = '';
  el('#file-upload-area').style.background = '';
  
  const files = Array.from(e.dataTransfer.files);
  const imageFiles = files.filter(file => file.type.match('image.*'));
  
  if (imageFiles.length === 0) {
    showToast('Please drop image files only', 'error');
    return;
  }
  
  // Check if adding these would exceed reasonable limit
  if (uploadedPhotos.length + imageFiles.length > 10) {
    showToast('Maximum 10 photos allowed', 'warning');
    return;
  }
  
  // Add each photo - FIXED: Now using await for each photo
  for (const file of imageFiles) {
    await addPhoto(file); // Wait for each photo to be added
  }
  
  showToast(`Added ${imageFiles.length} photo${imageFiles.length !== 1 ? 's' : ''} via drag & drop`, 'success');
});

/* Video upload button */
el('#video-upload-btn').addEventListener('click', () => el('#video-file-input').click());

el('#video-file-input').addEventListener('change', async function(ev) {
  const file = ev.target.files[0]; 
  if (!file) return;
  
  // Validate file type
  if (!file.type.match('video.*')) {
    alert('Please select a video file (MP4, MOV, etc.)');
    return;
  }
  
  // Show preview
  const videoPlayback = el('#video-playback');
  videoPlayback.src = URL.createObjectURL(file);
  videoPlayback.style.display = 'block';
  el('#camera-video').style.display = 'none';
  
  currentVideoBlob = file;
  updateVideoUI();
  showToast('Video uploaded successfully', 'success');
});

/* Video recording controls */
el('#video-record-btn').addEventListener('click', startVideoRecording);
el('#video-stop-btn').addEventListener('click', stopVideoRecording);

/* Submit video for analysis */
el('#video-submit-btn').addEventListener('click', async function() {
  if (!currentVideoBlob) {
    showToast('Please record or upload a video first', 'error');
    return;
  }
  
  if (scanInProgress) return;
  
  scanInProgress = true;
  el('#scan-status').textContent = 'Analyzing video...';
  
  // Simulate scanning progress
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += 5;
    el('#scan-progress').style.width = progress + '%';
    if (progress >= 100) {
      clearInterval(progressInterval);
    }
  }, 100);
  
  // Run mock video AI analysis
  setTimeout(async () => {
    clearInterval(progressInterval);
    el('#scan-progress').style.width = '100%';
    
    const result = mockVideoAIAnalyze(currentVideoBlob);
    el('#scan-status').textContent = 'Video analysis complete!';
    
    // Process the scan results
    processScanResults(result);
    
    scanInProgress = false;
  }, 3000);
});

/* Analyze photos button - FIXED: Now properly checks photo count */
el('#btn-analyze-photos').addEventListener('click', async function() {
  if (scanInProgress) return;
  
  // Double-check photo count
  if (uploadedPhotos.length < 3) {
    showToast(`Please upload at least 3 photos. You have ${uploadedPhotos.length}.`, 'error');
    return;
  }
  
  scanInProgress = true;
  el('#scan-status').textContent = `Analyzing ${uploadedPhotos.length} photos...`;
  
  // Simulate scanning progress
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += 5;
    el('#scan-progress').style.width = progress + '%';
    if (progress >= 100) {
      clearInterval(progressInterval);
    }
  }, 100);
  
  // Run mock multi-photo AI analysis
  setTimeout(async () => {
    clearInterval(progressInterval);
    el('#scan-progress').style.width = '100%';
    
    const result = mockMultiPhotoAIAnalyze(uploadedPhotos);
    el('#scan-status').textContent = 'Analysis complete!';
    
    // Process the scan results
    processScanResults(result);
    
    scanInProgress = false;
  }, 3000 + (uploadedPhotos.length * 500));
});

/* Process scan results and update app state */
function processScanResults(result) {
  // Check if scanning an existing animal or new one
  if (currentCameraTargetId) {
    // Update existing animal
    const animal = STATE.animals.find(a=>a.id===currentCameraTargetId);
    if (!animal) { 
      showToast('Animal missing', 'error'); 
      closeCameraModal(); 
      return; 
    }
    
    // Update animal data
    animal.health_status = result.overall_health === 'Critical' ? 'Critical' : 
                         (result.overall_health === 'Warning' ? 'Warning' : 'Good');
    animal.last_feed = new Date().toISOString();

    // Create alert if problem detected (based on wound detection)
    if (result.wound_detected){
      const alertId = 'a'+Date.now()+Math.floor(Math.random()*1000);
      const severity = result.overall_health === 'Critical' ? 'High' : 'Medium';
      const newAlert = { 
        alert_id: alertId, 
        animal_id: animal.id, 
        type: 'Wound detected', 
        severity, 
        timestamp: new Date().toISOString(),
        message: `Wound detected on ${result.wound_location}`
      };
      STATE.alerts.push(newAlert);
      animal.alerts = animal.alerts || []; 
      animal.alerts.push(newAlert);
      
      showToast(`Alert created for ${animal.name}`, result.overall_health === 'Critical' ? 'error' : 'warning');
    } else {
      showToast(`${animal.name} is healthy`, 'success');
    }
    
    // Save state
    saveState(STATE, currentUser.uid);
    
    // Update UI
    renderAllAlerts(); 
    renderAlertsPreview(); 
    renderAnimalsList(); 
    renderStats();
    
    // Show results modal
    setTimeout(() => {
      closeCameraModal();
      showScanResults(result, animal);
    }, 500);
    
  } else {
    // Scanning new or unidentified cattle
    let matchedAnimal = result.matched_animal;
    
    if (result.is_new_animal || !matchedAnimal) {
      // Create new animal
      const newAnimalId = 'cow-' + (STATE.animals.length + 1);
      const newAnimal = {
        id: newAnimalId,
        name: result.suggested_name || result.matched_animal?.name || `Cattle ${STATE.animals.length + 1}`,
        species: result.breed_detected,
        tag: result.tag_number,
        last_feed: new Date().toISOString(),
        health_status: result.overall_health === 'Critical' ? 'Critical' : 
                     (result.overall_health === 'Warning' ? 'Warning' : 'Good'),
        icon: 'ri-cow-line',
        alerts: []
      };
      
      STATE.animals.push(newAnimal);
      matchedAnimal = newAnimal;
      
      // Create alert if problem detected (wound only)
      if (result.wound_detected){
        const alertId = 'a'+Date.now()+Math.floor(Math.random()*1000);
        const severity = result.overall_health === 'Critical' ? 'High' : 'Medium';
        const newAlert = { 
          alert_id: alertId, 
          animal_id: newAnimalId, 
          type: 'Wound detected', 
          severity, 
          timestamp: new Date().toISOString(),
          message: `Wound detected on ${result.wound_location}`
        };
        STATE.alerts.push(newAlert);
        newAnimal.alerts.push(newAlert);
      }
      
      showToast(`New cattle added: ${newAnimal.name}`, 'success');
    } else {
      // Update existing matched animal
      matchedAnimal.health_status = result.overall_health === 'Critical' ? 'Critical' : 
                                   (result.overall_health === 'Warning' ? 'Warning' : 'Good');
      matchedAnimal.last_feed = new Date().toISOString();

      // Create alert if problem detected (wound only)
      if (result.wound_detected){
        const alertId = 'a'+Date.now()+Math.floor(Math.random()*1000);
        const severity = result.overall_health === 'Critical' ? 'High' : 'Medium';
        const newAlert = { 
          alert_id: alertId, 
          animal_id: matchedAnimal.id, 
          type: 'Wound detected', 
          severity, 
          timestamp: new Date().toISOString(),
          message: `Wound detected on ${result.wound_location}`
        };
        STATE.alerts.push(newAlert);
        matchedAnimal.alerts = matchedAnimal.alerts || [];
        matchedAnimal.alerts.push(newAlert);
        
        showToast(`Alert for ${matchedAnimal.name}`, result.overall_health === 'Critical' ? 'error' : 'warning');
      } else {
        showToast(`${matchedAnimal.name} scanned - All good`, 'success');
      }
    }
    
    // Save state
    saveState(STATE, currentUser.uid);
    
    // Update UI
    renderAllAlerts(); 
    renderAlertsPreview(); 
    renderAnimalsList(); 
    renderStats();
    
    // Show results modal
    setTimeout(() => {
      closeCameraModal();
      showScanResults(result, matchedAnimal);
    }, 500);
  }
}

/* Show scan results modal */
function showScanResults(result, matchedAnimal){
  // Store results globally for later use
  lastScanResult = result;
  lastScannedAnimal = matchedAnimal;
  
  // Determine health status color
  let healthStatusClass = 'scan-result-good';
  let healthStatusText = 'Good';
  let healthStatusIndicator = 'good';
  
  if (result.overall_health === 'Critical') {
    healthStatusClass = 'scan-result-danger';
    healthStatusText = 'Critical';
    healthStatusIndicator = 'danger';
  } else if (result.overall_health === 'Warning') {
    healthStatusClass = 'scan-result-warning';
    healthStatusText = 'Warning';
    healthStatusIndicator = 'warning';
  }
  
  // Build results HTML
  let resultsHTML = '';
  
  // Animal match section
  if (matchedAnimal) {
    resultsHTML += `
      <div class="animal-match">
        <div class="avatar" style="width:60px;height:60px;">
          <i class="${matchedAnimal.icon || 'ri-cow-line'}"></i>
        </div>
        <div class="animal-match-info">
          <div class="animal-match-name">${matchedAnimal.name}</div>
          <div class="muted small">${matchedAnimal.species} • ${matchedAnimal.tag}</div>
          <div class="match-confidence">Scan confidence: ${(result.confidence * 100).toFixed(1)}%</div>
        </div>
      </div>
    `;
  } else {
    resultsHTML += `
      <div class="animal-match">
        <div class="avatar" style="width:60px;height:60px;">
          <i class="ri-cow-line"></i>
        </div>
        <div class="animal-match-info">
          <div class="animal-match-name">New Cattle Detected</div>
          <div class="muted small">Ready to add to your herd</div>
          <div class="match-confidence">Detection confidence: ${(result.confidence * 100).toFixed(1)}%</div>
        </div>
      </div>
    `;
  }
  
  // Add analysis notes for multi-photo
  if (result.photos_analyzed) {
    resultsHTML += `
      <div class="info-note" style="margin: 12px 0;">
        <i class="ri-information-line"></i> ${result.analysis_notes}
      </div>
    `;
  }
  
  // Scan details
  resultsHTML += `
    <div style="margin: 20px 0;">
      <div class="scan-result-item">
        <div class="scan-result-label">Overall Health</div>
        <div class="scan-result-value">
          <span class="status-indicator ${healthStatusIndicator}">
            <i class="ri-heart-line"></i> ${healthStatusText}
          </span>
        </div>
      </div>
      
      <div class="scan-result-item">
        <div class="scan-result-label">Breed Detected</div>
        <div class="scan-result-value">${result.breed_detected}</div>
      </div>
      
      <div class="scan-result-item">
        <div class="scan-result-label">Movement Score</div>
        <div class="scan-result-value">${result.movement_score}</div>
      </div>
  `;
  
  // Add photos analyzed count
  if (result.photos_analyzed) {
    resultsHTML += `
      <div class="scan-result-item">
        <div class="scan-result-label">Photos Analyzed</div>
        <div class="scan-result-value">${result.photos_analyzed}</div>
      </div>
    `;
  }
  
  // Add video-specific results if available
  if (result.behavior_analysis) {
    resultsHTML += `
      <div class="scan-result-item">
        <div class="scan-result-label">Behavior Analysis</div>
        <div class="scan-result-value">${result.behavior_analysis}</div>
      </div>
    `;
  }
  
  if (result.video_duration) {
    resultsHTML += `
      <div class="scan-result-item">
        <div class="scan-result-label">Video Duration</div>
        <div class="scan-result-value">${result.video_duration}</div>
      </div>
    `;
  }
  
  // Add wound detection if present
  if (result.wound_detected) {
    resultsHTML += `
      <div class="scan-result-item">
        <div class="scan-result-label">Wound Detected</div>
        <div class="scan-result-value scan-result-${result.overall_health === 'Critical' ? 'danger' : 'warning'}">
          <i class="ri-alert-line"></i> ${result.wound_location}
        </div>
      </div>
    `;
  }
  
  resultsHTML += `</div>`;
  
  // Update results content
  el('#scan-results-content').innerHTML = resultsHTML;
  
  // Update view profile button text
  const viewProfileBtn = el('#results-view-profile');
  if (matchedAnimal) {
    viewProfileBtn.innerHTML = '<i class="ri-cow-line"></i> View Cattle Profile';
  } else {
    viewProfileBtn.innerHTML = '<i class="ri-user-add-line"></i> Add to Herd';
  }
  
  // Show the results modal
  el('#modal-results').classList.remove('hidden');
  el('#modal-results').ariaHidden = 'false';
}

/* Close scan results modal */
function closeScanResults(){
  el('#modal-results').classList.add('hidden');
  el('#modal-results').ariaHidden = 'true';
  lastScanResult = null;
  lastScannedAnimal = null;
}

/* Open camera modal utility */
el('#btn-scan-top').onclick = ()=>openCameraModal('scan', null);
el('#modal-camera-close').onclick = ()=>closeCameraModal();

/* Scan results modal handlers */
el('#modal-results-close').onclick = closeScanResults;

el('#results-scan-other').onclick = function() {
  closeScanResults();
  setTimeout(() => {
    openCameraModal('scan', null);
  }, 300);
};

el('#results-view-profile').onclick = function() {
  if (lastScannedAnimal) {
    closeScanResults();
    setTimeout(() => {
      openProfile(lastScannedAnimal.id);
    }, 300);
  } else {
    showToast('This cattle has been added to your herd.', 'success');
    closeScanResults();
  }
};

/* =====================
   Small UI bindings
   ===================== */
el('#back-to-dashboard').onclick = ()=>{ showView('dashboard'); }
el('#btn-open-alerts').onclick = ()=>{ showView('alerts'); }
el('#alerts-back').onclick = ()=>{ showView('dashboard'); }
el('#user-profile-back').onclick = ()=>{ showView('dashboard'); }

// Footer navigation
els('.nav-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const view = this.dataset.view;
    showView(view);
  });
});

// Notification button in header
el('#btn-notifications-header').addEventListener('click', function() {
  showView('alerts');
});

// Profile actions
el('#btn-logout-profile').addEventListener('click', handleLogout);

el('#btn-change-password').addEventListener('click', function() {
  showToast('Password change feature would be implemented in a production version', 'info');
});

el('#btn-notifications').addEventListener('click', function() {
  showToast('Notification settings would be implemented in a production version', 'info');
});

el('#btn-cattle-management').addEventListener('click', function() {
  showToast('Cattle management features would be implemented in a production version', 'info');
});

el('#btn-privacy').addEventListener('click', function() {
  showToast('Privacy settings would be implemented in a production version', 'info');
});

/* =====================
   Initialize App
   ===================== */
document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>
